"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8823],{3905:(e,a,n)=>{n.d(a,{Zo:()=>u,kt:()=>f});var t=n(67294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function s(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?s(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function i(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},s=Object.keys(e);for(t=0;t<s.length;t++)n=s[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(t=0;t<s.length;t++)n=s[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=t.createContext({}),d=function(e){var a=t.useContext(l),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},u=function(e){var a=d(e.components);return t.createElement(l.Provider,{value:a},e.children)},p={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},c=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=d(n),f=r,g=c["".concat(l,".").concat(f)]||c[f]||p[f]||s;return n?t.createElement(g,o(o({ref:a},u),{},{components:n})):t.createElement(g,o({ref:a},u))}));function f(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var s=n.length,o=new Array(s);o[0]=c;var i={};for(var l in a)hasOwnProperty.call(a,l)&&(i[l]=a[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var d=2;d<s;d++)o[d]=n[d];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}c.displayName="MDXCreateElement"},37196:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var t=n(87462),r=(n(67294),n(3905));const s={},o="K8S \u4e2d\u7684 Grafana \u6570\u636e\u6301\u4e45\u5316",i={unversionedId:"prometheus/Instrumenting/grafana-kubernetes-config-persistence",id:"prometheus/Instrumenting/grafana-kubernetes-config-persistence",title:"K8S \u4e2d\u7684 Grafana \u6570\u636e\u6301\u4e45\u5316",description:"\u81ea\u4ece\u5c06 Grafana \u90e8\u7f72\u5230 K8S \u4e2d\u4ee5\u540e\uff0c\u5e26\u6765\u4e86\u5f88\u591a\u7684\u4fbf\u5229\u6027\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u95ee\u9898\u4e00\u76f4\u56f0\u6270\u7740\u6211\uff0c\u90a3\u5c31\u662f Grafana \u4e2d\u7684\u6570\u636e\u65e0\u6cd5\u6301\u4e45\u5316\uff0c\u7ecf\u5e38\u914d\u7f6e\u597d\u7684 Datasource \u548c Dashboards \u5728\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\u5c31\u4e22\u5931\u4e86\uff0c\u6709\u65f6\u5019\u521a\u8981\u6392\u67e5\u95ee\u9898\uff0c\u7ed3\u679c\u4ec0\u4e48\u90fd\u627e\u4e0d\u5230\u4e86\u3002\u6211\u4eec\u90fd\u77e5\u9053\uff0cGrafana \u5728\u542f\u52a8\u540e\uff0c\u6570\u636e\u4f1a\u5b58\u50a8\u5230\u6570\u636e\u5e93\u4e2d\uff0c\u5305\u62ec datasource \u7684\u914d\u7f6e\uff0cDashboards \u7684\u914d\u7f6e\u3002\u8981\u89e3\u51b3 Grafana \u7684\u6570\u636e\u6301\u4e45\u5316\u53ef\u4ee5\u4ece 2 \u4e2a\u65b9\u9762\u6765\u8fdb\u884c\u601d\u8003\u5e76\u4e14\u89e3\u51b3\u3002",source:"@site/wiki/ops/prometheus/06-Instrumenting/grafana-kubernetes-config-persistence.md",sourceDirName:"prometheus/06-Instrumenting",slug:"/prometheus/Instrumenting/grafana-kubernetes-config-persistence",permalink:"/zhengxuexian_blog/ops/prometheus/Instrumenting/grafana-kubernetes-config-persistence",draft:!1,tags:[],version:"current",lastUpdatedBy:"zhengxuexian",lastUpdatedAt:1661407442,formattedLastUpdatedAt:"2022\u5e748\u670825\u65e5",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u5c0f\u7ed3",permalink:"/zhengxuexian_blog/ops/prometheus/PromQL/END"},next:{title:"\u7b2c\u4e03\u7ae0 \u96c6\u7fa4\u4e0e\u9ad8\u53ef\u7528",permalink:"/zhengxuexian_blog/ops/prometheus/ClusterAndHA/"}},l={},d=[],u={toc:d};function p(e){let{components:a,...n}=e;return(0,r.kt)("wrapper",(0,t.Z)({},u,n,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"k8s-\u4e2d\u7684-grafana-\u6570\u636e\u6301\u4e45\u5316"},"K8S \u4e2d\u7684 Grafana \u6570\u636e\u6301\u4e45\u5316"),(0,r.kt)("p",null,"\u81ea\u4ece\u5c06 Grafana \u90e8\u7f72\u5230 K8S \u4e2d\u4ee5\u540e\uff0c\u5e26\u6765\u4e86\u5f88\u591a\u7684\u4fbf\u5229\u6027\uff0c\u4f46\u662f\u4e5f\u6709\u4e00\u4e2a\u95ee\u9898\u4e00\u76f4\u56f0\u6270\u7740\u6211\uff0c\u90a3\u5c31\u662f Grafana \u4e2d\u7684\u6570\u636e\u65e0\u6cd5\u6301\u4e45\u5316\uff0c\u7ecf\u5e38\u914d\u7f6e\u597d\u7684 Datasource \u548c Dashboards \u5728\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\u5c31\u4e22\u5931\u4e86\uff0c\u6709\u65f6\u5019\u521a\u8981\u6392\u67e5\u95ee\u9898\uff0c\u7ed3\u679c\u4ec0\u4e48\u90fd\u627e\u4e0d\u5230\u4e86\u3002\u6211\u4eec\u90fd\u77e5\u9053\uff0cGrafana \u5728\u542f\u52a8\u540e\uff0c\u6570\u636e\u4f1a\u5b58\u50a8\u5230\u6570\u636e\u5e93\u4e2d\uff0c\u5305\u62ec datasource \u7684\u914d\u7f6e\uff0cDashboards \u7684\u914d\u7f6e\u3002\u8981\u89e3\u51b3 Grafana \u7684\u6570\u636e\u6301\u4e45\u5316\u53ef\u4ee5\u4ece 2 \u4e2a\u65b9\u9762\u6765\u8fdb\u884c\u601d\u8003\u5e76\u4e14\u89e3\u51b3\u3002"),(0,r.kt)("p",null,"\u65b9\u6848\u4e00\uff1a"),(0,r.kt)("p",null,"Grafana \u6570\u636e\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\uff0c\u5f53\u524d\u652f\u6301 MySQL \u3001sqlite3\u3001Postgres \u8fd9\u4e09\u4e2a\uff0c\u7f3a\u7701\u60c5\u51b5\u4e0b\uff0cGrafana \u4f1a\u5728\u672c\u5730\u542f\u52a8\u4e00\u4e2a Sqlite3 \u6765\u5b58\u50a8\u6570\u636e\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5728 grafana.ini \u914d\u7f6e\u6587\u4ef6\u4e2d\u4fee\u6539\u8fd9\u4e2a\u914d\u7f6e\u6765\u5207\u6362\u6570\u636e\u5e93\u3002"),(0,r.kt)("p",null,"\u57fa\u4e8e\u8fd9\u4e2a\u65b9\u5f0f\uff0c\u7b2c\u4e00\u79cd\u65b9\u6848\u51fa\u6765\u4e86\u3002 \u5f53 Grafana \u8fd0\u884c\u5728 K8S \u4e2d\u65f6\uff0c\u6570\u636e\u5e93\u4e0d\u4f7f\u7528\u81ea\u52a8\u542f\u52a8\u7684 Sqlite3 \uff0c\u5728 K8S \u5916\u542f\u52a8\u4e00\u4e2a\u5173\u7cfb\u6570\u636e\u5e93\uff08\u53ef\u4ee5\u662f MySQL \u3001sqlite3\u3001Postgres \u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\uff09\uff0c\u4fee\u6539 grafana.ini \u6587\u4ef6\uff0c\u4f7f\u5f97 Grafana \u5728\u542f\u52a8\u65f6\u8fde\u63a5\u5916\u90e8\u7684\u6570\u636e\u5e93\uff0c\u8fd9\u6837\u6570\u636e\u5c31\u4e0d\u4f1a\u4e22\u5931\u4e86\u3002"),(0,r.kt)("p",null,"\u65b9\u6848\u4e8c\uff1a"),(0,r.kt)("p",null,"Grafana \u5728 v5.0 \u4e4b\u540e\u5f15\u5165\u4e86 provisioning \u529f\u80fd\uff0c\u53ef\u4ee5\u5c06 Datasource \u3001Dashboards \u8fd9\u4e9b\u5185\u5bb9\uff0c\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u7684\u65b9\u5f0f\u5728 Grafana \u542f\u52a8\u7684\u65f6\u5019\u52a0\u8f7d\u3002\u628a\u8fd9\u4e9b\u6587\u4ef6\u653e\u5728 K8S \u7684\u914d\u7f6e\u6620\u5c04\u4e2d\uff0c\u7136\u540e\u6302\u8f7d\u5230 Grafana \u5bb9\u5668\u4e2d\u7684\u6307\u5b9a\u8def\u5f84\u5373\u53ef\u3002\u8fd9\u6837\u914d\u7f6e\u540e\u5728 Web UI \u4fee\u6539\u5df2\u7ecf\u4e0d\u4f1a\u751f\u6548\uff0c\u53ea\u6709\u5728\u5bf9\u5e94\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u4fee\u6539\u624d\u4f1a\u751f\u6548\u3002"),(0,r.kt)("p",null,"\u63a5\u4e0b\u91cc\u6211\u4eec\u770b\u770b\u65b9\u6848\u4e8c\u7684\u600e\u4e48\u914d\u7f6e\u4f7f\u7528\uff0c\u6211\u4f7f\u7528\u7684 Grafana \u7248\u672c\u662f v6.4.3\u3002"),(0,r.kt)("p",null,"\u9996\u5148\u9700\u8981\u5728 Grafana \u542f\u52a8\u65f6\u6dfb\u52a0\u76f8\u5e94\u7684\u53c2\u6570\u6765\u6253\u5f00 provisioning \u529f\u80fd\uff0c\u5b98\u65b9\u63d0\u4f9b\u7684 docker \u955c\u50cf\u5df2\u7ecf\u5c06\u8be5\u529f\u80fd\u6253\u5f00\uff0c\u7f3a\u7701\u7684\u8def\u5f84\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/grafana/provisioning")," ,\u8fd9\u4e2a\u8def\u5f84\u4e0b\u6709 dashboards\u3001datasources\u3001notifiers \u4e09\u4e2a\u6587\u4ef6\u5939\uff0c\u76f8\u5173\u7684\u914d\u7f6e\u4f1a\u653e\u5728\u8fd9\u91cc\u3002\u5982\u679c\u662f\u81ea\u5df1\u6784\u5efa\u7684\u955c\u50cf\uff0c\u8bf7\u53c2\u8003\u6587\u6863\u6216\u8005\u5b98\u65b9\u7684 dockerfile \u628a\u8be5\u529f\u80fd\u6253\u5f00\u3002"),(0,r.kt)("p",null,"\u5176\u6b21\u6211\u4eec\u9700\u8981\u89e3\u51b3\u6570\u636e\u6e90\u7684\u6301\u4e45\u5316\u95ee\u9898\uff0c\u6211\u4eec\u51c6\u5907 datasources.yaml \u6587\u4ef6\uff0c\u7528\u6765\u914d\u7f6e\u6570\u636e\u6e90\u3002datasources.yaml \u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"# config file version\napiVersion: 1\n\n# list of datasources that should be deleted from the database\ndeleteDatasources:\n  - name: Prometheus\n    orgId: 1\n\n# list of datasources to insert/update depending\n# what's available in the database\ndatasources:\n  # <string, required> name of the datasource. Required\n  - name: Prometheus\n    # <string, required> datasource type. Required\n    type: prometheus\n    # <string, required> access mode. proxy or direct (Server or Browser in the UI). Required\n    access: proxy\n    # <int> org id. will default to orgId 1 if not specified\n    orgId: 1\n    # <string> custom UID which can be used to reference this datasource in other parts of the configuration, if not specified will be generated automatically\n    uid: my_unique_uid\n    # <string> url\n    url: http://127.0.0.1:9090\n    # <string> Deprecated, use secureJsonData.password\n    password:\n    # <string> database user, if used\n    user:\n    # <string> database name, if used\n    database:\n    # <bool> enable/disable basic auth\n    basicAuth:\n    # <string> basic auth username\n    basicAuthUser:\n    # <string> Deprecated, use secureJsonData.basicAuthPassword\n    basicAuthPassword:\n    # <bool> enable/disable with credentials headers\n    withCredentials:\n    # <bool> mark as default datasource. Max one per org\n    isDefault:\n    # <map> fields that will be converted to json and stored in jsonData\n    jsonData:\n      graphiteVersion: '1.1'\n      tlsAuth: false\n      tlsAuthWithCACert: false\n    # <string> json object of data that will be encrypted.\n    secureJsonData:\n      tlsCACert: '...'\n      tlsClientCert: '...'\n      tlsClientKey: '...'\n      # <string> database password, if used\n      password:\n      # <string> basic auth password\n      basicAuthPassword:\n    version: 1\n    # <bool> allow users to edit datasources from the UI.\n    editable: false\n")),(0,r.kt)("p",null,"\u5c06\u8be5\u6587\u4ef6\u653e\u5728 K8S \u7684 config map \u4e2d\uff0c\u5728\u5bb9\u5668\u4e2d\u65f6\u6dfb\u52a0\u6570\u636e\u5377\uff0c\u5377\u7c7b\u578b\u9009",(0,r.kt)("inlineCode",{parentName:"p"},"\u914d\u7f6e\u6620\u5c04\u5377")," \uff0c\u9009\u62e9 config map \u4e2d\u7684 datasources.yaml \u6302\u8f7d\u5230\u5bb9\u5668\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/grafana/provisioning/datasources")," ,\u7136\u540e\u91cd\u542f\u5bb9\u5668\uff0c\u8ba9\u5bb9\u5668\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u3002"),(0,r.kt)("p",null,"\u4f7f\u7528\u540e\u5728 Web UI \u7684\u6570\u636e\u6e90\u9875\u9762\u8fdb\u884c\u4fee\u6539\u4f1a\u63d0\u793a ",(0,r.kt)("inlineCode",{parentName:"p"},"This datasource was added by config and cannot be modified using the UI. Please contact your server admin to update this datasource. ")," \u8868\u793a\u6570\u636e\u6e90\u7684\u914d\u7f6e\uff0c\u5728 Web UI \u4fee\u6539\u5df2\u7ecf\u4e0d\u4f1a\u751f\u6548\uff0c\u53ea\u6709\u5728 datasources.yaml \u6587\u4ef6\u4e2d\u4fee\u6539\u624d\u4f1a\u751f\u6548\u3002"),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\u89e3\u51b3 dashboards \u7684\u6301\u4e45\u5316\u95ee\u9898\uff0c\u51c6\u5907 ",(0,r.kt)("inlineCode",{parentName:"p"},"dashboards.yaml")," \u6587\u4ef6\uff0c\u7528\u6765\u6307\u5b9a\u4e4b\u540e\u7684 dashboards \u7684 json \u6587\u4ef6\u653e\u5728\u54ea\u4e2a\u76ee\u5f55\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"apiVersion: 1\n\nproviders:\n  # <string> an unique provider name. Required\n  - name: 'a unique provider name'\n    # <int> Org id. Default to 1\n    orgId: 1\n    # <string> name of the dashboard folder.\n    folder: ''\n    # <string> folder UID. will be automatically generated if not specified\n    folderUid: ''\n    # <string> provider type. Default to 'file'\n    type: file\n    # <bool> disable dashboard deletion\n    disableDeletion: false\n    # <bool> enable dashboard editing\n    editable: true\n    # <int> how often Grafana will scan for changed dashboards\n    updateIntervalSeconds: 10\n    # <bool> allow updating provisioned dashboards from the UI\n    allowUiUpdates: false\n    options:\n      # <string, required> path to dashboard files on disk. Required when using the 'file' type\n      path: /etc/grafana/dashboards-files\n")),(0,r.kt)("p",null,"\u5c06\u8be5\u6587\u4ef6\u653e\u5728 K8S \u7684 config map \u4e2d\uff0c\u5728\u5bb9\u5668\u4e2d\u65f6\u6dfb\u52a0\u6570\u636e\u5377\uff0c\u5377\u7c7b\u578b\u9009",(0,r.kt)("inlineCode",{parentName:"p"},"\u914d\u7f6e\u6620\u5c04\u5377")," \uff0c\u9009\u62e9 config map \u4e2d\u7684 dashboards.yaml \u6302\u8f7d\u5230\u5bb9\u5668\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/grafana/provisioning/dashboards")," ,\u7136\u540e\u91cd\u542f\u5bb9\u5668\uff0c\u8ba9\u5bb9\u5668\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u3002"),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\u5c06\u51c6\u5907\u597d\u7684 json \u683c\u5f0f\u7684 Dashboards \u6587\u4ef6\u653e\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/grafana/dashboards-files"),",  \u91cd\u65b0\u52a0\u8f7d\u8fd9\u4e9b json \u6587\u4ef6\u5373\u53ef\u3002"),(0,r.kt)("h1",{id:"\u53c2\u8003\u94fe\u63a5"},"\u53c2\u8003\u94fe\u63a5\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://grafana.com/docs/grafana/latest/administration/provisioning/#provisioning-grafana"},"https://grafana.com/docs/grafana/latest/administration/provisioning/#provisioning-grafana")," , By Provisioning Grafanan")))}p.isMDXComponent=!0}}]);